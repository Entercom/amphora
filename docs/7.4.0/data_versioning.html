<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><title>Data Versioning (Upgrades) · Amphora</title><meta name="viewport" content="width=device-width"/><meta name="generator" content="Docusaurus"/><meta name="description" content="Data versioning is a feature of Amphora that aims to address the problem of iterating on component data. As properties are added or removed from a component&#x27;s data it&#x27;s easy to reach a point where data that is already in the database does not meet the requirements/expectations of a template or `model.js`. Data versioning allows you to track which &quot;version&quot; of data your component is on and then bring old data up to that current version, increasing the rate at which new features can be developed around a component."/><meta name="docsearch:version" content="7.4.0"/><meta name="docsearch:language" content="en"/><meta property="og:title" content="Data Versioning (Upgrades) · Amphora"/><meta property="og:type" content="website"/><meta property="og:url" content="https://clay.github.io/amphora/"/><meta property="og:description" content="Data versioning is a feature of Amphora that aims to address the problem of iterating on component data. As properties are added or removed from a component&#x27;s data it&#x27;s easy to reach a point where data that is already in the database does not meet the requirements/expectations of a template or `model.js`. Data versioning allows you to track which &quot;version&quot; of data your component is on and then bring old data up to that current version, increasing the rate at which new features can be developed around a component."/><meta name="twitter:card" content="summary"/><link rel="shortcut icon" href="/amphora/"/><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css"/><script type="text/javascript" src="https://buttons.github.io/buttons.js"></script><script src="/amphora/js/scrollSpy.js"></script><link rel="stylesheet" href="/amphora/css/main.css"/><script src="/amphora/js/codetabs.js"></script></head><body class="sideNavVisible separateOnPageNav"><div class="fixedHeaderContainer"><div class="headerWrapper wrapper"><header><a href="/amphora/"><img class="logo" src="/amphora/img/amphora-logo.svg" alt="Amphora"/><h2 class="headerTitleWithLogo">Amphora</h2></a><a href="/amphora/versions"><h3>7.4.0</h3></a><div class="navigationWrapper navigationSlider"><nav class="slidingNav"><ul class="nav-site nav-site-internal"><li class="siteNavGroupActive"><a href="/amphora/docs/7.4.0/intro" target="_self">Introduction</a></li><li class=""><a href="https://github.com/clay/amphora" target="_self">Github</a></li></ul></nav></div></header></div></div><div class="navPusher"><div class="docMainWrapper wrapper"><div class="docsNavContainer" id="docsNav"><nav class="toc"><div class="toggleNav"><section class="navWrapper wrapper"><div class="navBreadcrumb wrapper"><div class="navToggle" id="navToggler"><div class="hamburger-menu"><div class="line1"></div><div class="line2"></div><div class="line3"></div></div></div><h2><i>›</i><span>Advanced</span></h2><div class="tocToggler" id="tocToggler"><i class="icon-toc"></i></div></div><div class="navGroups"><div class="navGroup"><h3 class="navGroupCategoryTitle collapsible">Introduction<span class="arrow"><svg width="24" height="24" viewBox="0 0 24 24"><path fill="#565656" d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path><path d="M0 0h24v24H0z" fill="none"></path></svg></span></h3><ul class="hide"><li class="navListItem"><a class="navItem" href="/amphora/docs/7.4.0/intro">Introduction</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle collapsible">On Startup<span class="arrow"><svg width="24" height="24" viewBox="0 0 24 24"><path fill="#565656" d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path><path d="M0 0h24v24H0z" fill="none"></path></svg></span></h3><ul class="hide"><li class="navListItem"><a class="navItem" href="/amphora/docs/7.4.0/startup">Startup</a></li><li class="navListItem"><a class="navItem" href="/amphora/docs/7.4.0/install">Instantiation Arguments</a></li><li class="navListItem"><a class="navItem" href="/amphora/docs/7.4.0/bootstrap">Bootstrapping</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle collapsible">Basics<span class="arrow"><svg width="24" height="24" viewBox="0 0 24 24"><path fill="#565656" d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path><path d="M0 0h24v24H0z" fill="none"></path></svg></span></h3><ul class="hide"><li class="navListItem"><a class="navItem" href="/amphora/docs/7.4.0/routes">Routing</a></li><li class="navListItem"><a class="navItem" href="/amphora/docs/7.4.0/publish">Publishing</a></li><li class="navListItem"><a class="navItem" href="/amphora/docs/7.4.0/plugin">Plugin</a></li><div class="navGroup subNavGroup"><h4 class="navGroupSubcategoryTitle">Renderers</h4><ul><li class="navListItem"><a class="navItem" href="/amphora/docs/7.4.0/building-renderers">Building Custom Renderers</a></li></ul></div><li class="navListItem"><a class="navItem" href="/amphora/docs/7.4.0/event-bus">Event Bus</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle collapsible">Advanced<span class="arrow"><svg width="24" height="24" viewBox="0 0 24 24"><path fill="#565656" d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path><path d="M0 0h24v24H0z" fill="none"></path></svg></span></h3><ul class="hide"><li class="navListItem"><a class="navItem" href="/amphora/docs/7.4.0/advanced">Advanced</a></li><li class="navListItem"><a class="navItem" href="/amphora/docs/7.4.0/storage">Storage API</a></li><li class="navListItem navListItemActive"><a class="navItem" href="/amphora/docs/7.4.0/data_versioning">Data Versioning (Upgrades)</a></li><li class="navListItem"><a class="navItem" href="/amphora/docs/7.4.0/renderer-models">Renderer Models</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle collapsible">Helpful Links<span class="arrow"><svg width="24" height="24" viewBox="0 0 24 24"><path fill="#565656" d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path><path d="M0 0h24v24H0z" fill="none"></path></svg></span></h3><ul class="hide"><li class="navListItem"><a class="navItem" href="/amphora/docs/7.4.0/glossary-docs">Glossary</a></li></ul></div></div></section></div><script>
            var coll = document.getElementsByClassName('collapsible');
            var checkActiveCategory = true;
            for (var i = 0; i < coll.length; i++) {
              var links = coll[i].nextElementSibling.getElementsByTagName('*');
              if (checkActiveCategory){
                for (var j = 0; j < links.length; j++) {
                  if (links[j].classList.contains('navListItemActive')){
                    coll[i].nextElementSibling.classList.toggle('hide');
                    coll[i].childNodes[1].classList.toggle('rotate');
                    checkActiveCategory = false;
                    break;
                  }
                }
              }

              coll[i].addEventListener('click', function() {
                var arrow = this.childNodes[1];
                arrow.classList.toggle('rotate');
                var content = this.nextElementSibling;
                content.classList.toggle('hide');
              });
            }

            document.addEventListener('DOMContentLoaded', function() {
              createToggler('#navToggler', '#docsNav', 'docsSliderActive');
              createToggler('#tocToggler', 'body', 'tocActive');

              var headings = document.querySelector('.toc-headings');
              headings && headings.addEventListener('click', function(event) {
                var el = event.target;
                while(el !== headings){
                  if (el.tagName === 'A') {
                    document.body.classList.remove('tocActive');
                    break;
                  } else{
                    el = el.parentNode;
                  }
                }
              }, false);

              function createToggler(togglerSelector, targetSelector, className) {
                var toggler = document.querySelector(togglerSelector);
                var target = document.querySelector(targetSelector);

                if (!toggler) {
                  return;
                }

                toggler.onclick = function(event) {
                  event.preventDefault();

                  target.classList.toggle(className);
                };
              }
            });
        </script></nav></div><div class="container mainContainer"><div class="wrapper"><div class="post"><header class="postHeader"><h1 class="postHeaderTitle">Data Versioning (Upgrades)</h1></header><article><div><span><p>Data versioning is a feature of Amphora that aims to address the problem of iterating on component data. As properties are added or removed from a component's data it's easy to reach a point where data that is already in the database does not meet the requirements/expectations of a template or <code>model.js</code>. Data versioning allows you to track which &quot;version&quot; of data your component is on and then bring old data up to that current version, increasing the rate at which new features can be developed around a component.</p>
<h2><a class="anchor" aria-hidden="true" id="upgrading-component-data"></a><a href="#upgrading-component-data" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>&quot;Upgrading&quot; Component Data</h2>
<p>Components follow a very defined path when they're requested. First, the data is retrieved from the database and then it's passed to a <code>model.js</code> <code>render</code> function for the component (if one exists). After that, the component data proceeds to the final output destination, whether that's to be templated into HTML or to be consumed as JSON. Upgrades take place immediately after a component's data is retrieved from the database, making the modified data accessible the <code>model.js</code>.</p>
<p><img src="/amphora/img/upgrade_flow.png" alt="Upgrade data flow"></p>
<h2><a class="anchor" aria-hidden="true" id="how-to-upgrade"></a><a href="#how-to-upgrade" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>How To Upgrade</h2>
<p>Upgrading is easy! You only need two things:</p>
<ul>
<li>A <code>_version</code> property set to a number in your component's <code>schema.yaml</code></li>
<li>An <code>upgrade.js</code> file in your component's directory</li>
</ul>
<h3><a class="anchor" aria-hidden="true" id="_version-property"></a><a href="#_version-property" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>_version Property</h3>
<p>The <code>_version</code> property is how upgrades are tracked by Amphora. Whenever a component's data is requested the <code>_version</code> property in your component's data is checked against the <code>_version</code> property in your component's <code>schema</code> file. If the two are not the same value, the component's data will be run through whatever upgrades are specified in your <code>upgrade.js</code> file. Things to note about this property:</p>
<ul>
<li>You should never modify the <code>_version</code> property in your component, Amphora will manage this for you</li>
<li>The property format <code>&lt;MAJOR&gt;.&lt;MINOR&gt;</code> (i.e. <code>1.6</code>). This allows you to specify &quot;breaking&quot; changes in your component data (usually removing a property)</li>
</ul>
<h3><a class="anchor" aria-hidden="true" id="upgradejs-file"></a><a href="#upgradejs-file" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Upgrade.js file</h3>
<p>If the schema specifies <em>what</em> version a component's data should be at, an <code>upgrade.js</code> file describes <em>how</em> to get to that version. An <code>upgrade.js</code> should export a function for each version number of the schema that you have. For example, if you're writing your first upgrade for a component and want to write an upgrade to <code>1.0</code>, your <code>upgrade.js</code> would have the following:</p>
<pre><code class="hljs css language-javascript"><span class="hljs-built_in">module</span>.exports[<span class="hljs-string">'1.0'</span>] = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
  <span class="hljs-comment">//...upgrade goes here</span>
};
</code></pre>
<p>For every version that you increment, just add a corresponding function and they'll be run! But what about the structure of the function? The function signature for an <code>upgrade.js</code> file is the exact same as a <code>model.js</code> file. The functions will receive the same arguments and should return a Javascript Object or a <code>Promise</code> that resolves an Object.</p>
<pre><code class="hljs css language-javascript"><span class="hljs-built_in">module</span>.exports[<span class="hljs-string">'1.0'</span>] = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">uri, data, locals</span>) </span>{
  <span class="hljs-comment">// Modify your `data` here and return a Promise or JS Object</span>
};
</code></pre>
<h2><a class="anchor" aria-hidden="true" id="faq"></a><a href="#faq" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>FAQ</h2>
<h3><a class="anchor" aria-hidden="true" id="so-all-the-upgrades-for-a-component-run-every-time-a-component-is-requested"></a><a href="#so-all-the-upgrades-for-a-component-run-every-time-a-component-is-requested" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>So all the upgrades for a component run every time a component is requested?</h3>
<p>An upgrade is only run <strong>once</strong> per component instance. The <code>_version</code> property is used to track the version of the data and then upgrades are reduced through, make sure that upgrades are run in ascending order.</p>
<p>For example, if your component data is on version <code>1.0</code> and your schema version is at <code>1.6</code>, Amphora will run your data through each upgrade (from <code>1.1</code> to <code>1.6</code>) and return the data expected for <code>1.6</code>. In this way, even the oldest data in your system is up-to-date with <code>model.js</code> and template expectations.</p>
<h3><a class="anchor" aria-hidden="true" id="why-not-just-use-an-external-script-or-render-function"></a><a href="#why-not-just-use-an-external-script-or-render-function" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Why not just use an external script or render function?</h3>
<p>Transforming data in a <code>model.js</code> <code>render</code> function will lead to bloat of the file which will require more development time as devs must keep all of the possible permutations of the data in mind when making changes.</p>
<p>Using an external script will require careful coordination when releasing new features and updating data.</p>
<p>Data versioning allows you iterate and release without fear that your data needs to undergo its own migration.</p>
</span></div></article></div><div class="docs-prevnext"><a class="docs-prev button" href="/amphora/docs/7.4.0/storage"><span class="arrow-prev">← </span><span>Storage API</span></a><a class="docs-next button" href="/amphora/docs/7.4.0/renderer-models"><span>Renderer Models</span><span class="arrow-next"> →</span></a></div></div></div><nav class="onPageNav"><ul class="toc-headings"><li><a href="#quot-upgrading-quot-component-data">&quot;Upgrading&quot; Component Data</a></li><li><a href="#how-to-upgrade">How To Upgrade</a><ul class="toc-headings"><li><a href="#_version-property">_version Property</a></li><li><a href="#upgradejs-file">Upgrade.js file</a></li></ul></li><li><a href="#faq">FAQ</a><ul class="toc-headings"><li><a href="#so-all-the-upgrades-for-a-component-run-every-time-a-component-is-requested">So all the upgrades for a component run every time a component is requested?</a></li><li><a href="#why-not-just-use-an-external-script-or-render-function">Why not just use an external script or render function?</a></li></ul></li></ul></nav></div><footer class="nav-footer" id="footer"><section class="sitemap"><a href="/amphora/" class="nav-home"></a><div><h5>Docs</h5><a href="/amphora/docs/en/intro">Introduction</a><a href="/amphora/docs/en/glossary-docs">Glossary</a></div><div><h5>More</h5><a target="_blank" href="https://github.com/clay/amphora">GitHub</a></div></section><section class="copyright">Copyright © 2019 New York Media</section></footer></div></body></html>