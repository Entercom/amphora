<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><title>Event Bus · Amphora</title><meta name="viewport" content="width=device-width"/><meta name="generator" content="Docusaurus"/><meta name="description" content="&lt;p&gt;As of Amphora version &lt;code&gt;6.6.0&lt;/code&gt;, the option of using &lt;a href=&quot;https://redis.io/topics/pubsub&quot;&gt;Redis as an event bus&lt;/a&gt; has been introduced. This event bus is intended to make it easier to a destructure a Clay instance and supporting platform packages (i.e. Amphora Search). By default, the Bus module is not instantiated. Only by setting the &lt;a href=&quot;event-bus#redis-bus-host&quot;&gt;Redis Bus Host env var&lt;/a&gt; will the Bus module be active.&lt;/p&gt;
"/><meta name="docsearch:version" content="7.3.2"/><meta name="docsearch:language" content="en"/><meta property="og:title" content="Event Bus · Amphora"/><meta property="og:type" content="website"/><meta property="og:url" content="https://docs.clayplatform.com//amphora/index.html"/><meta property="og:description" content="&lt;p&gt;As of Amphora version &lt;code&gt;6.6.0&lt;/code&gt;, the option of using &lt;a href=&quot;https://redis.io/topics/pubsub&quot;&gt;Redis as an event bus&lt;/a&gt; has been introduced. This event bus is intended to make it easier to a destructure a Clay instance and supporting platform packages (i.e. Amphora Search). By default, the Bus module is not instantiated. Only by setting the &lt;a href=&quot;event-bus#redis-bus-host&quot;&gt;Redis Bus Host env var&lt;/a&gt; will the Bus module be active.&lt;/p&gt;
"/><meta name="twitter:card" content="summary"/><link rel="shortcut icon" href="/amphora/"/><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css"/><script type="text/javascript" src="https://buttons.github.io/buttons.js"></script><link rel="stylesheet" href="/amphora/css/main.css"/><script src="/amphora/js/codetabs.js"></script></head><body class="sideNavVisible separateOnPageNav"><div class="fixedHeaderContainer"><div class="headerWrapper wrapper"><header><a href="/amphora/"><img class="logo" src="/amphora/img/amphora-logo.svg" alt="Amphora"/><h2 class="headerTitleWithLogo">Amphora</h2></a><a href="/amphora/versions"><h3>7.3.2</h3></a><div class="navigationWrapper navigationSlider"><nav class="slidingNav"><ul class="nav-site nav-site-internal"><li class="siteNavGroupActive"><a href="/amphora/docs/intro" target="_self">Introduction</a></li><li class=""><a href="https://github.com/clay/amphora" target="_self">Github</a></li></ul></nav></div></header></div></div><div class="navPusher"><div class="docMainWrapper wrapper"><div class="container docsNavContainer" id="docsNav"><nav class="toc"><div class="toggleNav"><section class="navWrapper wrapper"><div class="navBreadcrumb wrapper"><div class="navToggle" id="navToggler"><i></i></div><h2><i>›</i><span>Basics</span></h2><div class="tocToggler" id="tocToggler"><i class="icon-toc"></i></div></div><div class="navGroups"><div class="navGroup"><h3 class="navGroupCategoryTitle collapsible">Introduction<span class="arrow"><svg width="24" height="24" viewBox="0 0 24 24"><path fill="#565656" d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path><path d="M0 0h24v24H0z" fill="none"></path></svg></span></h3><ul class="hide"><li class="navListItem"><a class="navItem" href="/amphora/docs/intro">Introduction</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle collapsible">On Startup<span class="arrow"><svg width="24" height="24" viewBox="0 0 24 24"><path fill="#565656" d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path><path d="M0 0h24v24H0z" fill="none"></path></svg></span></h3><ul class="hide"><li class="navListItem"><a class="navItem" href="/amphora/docs/startup">Startup</a></li><li class="navListItem"><a class="navItem" href="/amphora/docs/install">Instantiation Arguments</a></li><li class="navListItem"><a class="navItem" href="/amphora/docs/bootstrap">Bootstrapping</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle collapsible">Basics<span class="arrow"><svg width="24" height="24" viewBox="0 0 24 24"><path fill="#565656" d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path><path d="M0 0h24v24H0z" fill="none"></path></svg></span></h3><ul class="hide"><li class="navListItem"><a class="navItem" href="/amphora/docs/routes">Routing</a></li><li class="navListItem"><a class="navItem" href="/amphora/docs/publish">Publishing</a></li><div class="navGroup subNavGroup"><h4 class="navGroupSubcategoryTitle">Renderers</h4><ul><li class="navListItem"><a class="navItem" href="/amphora/docs/building-renderers">Building Custom Renderers</a></li></ul></div><li class="navListItem navListItemActive"><a class="navItem" href="/amphora/docs/event-bus">Event Bus</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle collapsible">Advanced<span class="arrow"><svg width="24" height="24" viewBox="0 0 24 24"><path fill="#565656" d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path><path d="M0 0h24v24H0z" fill="none"></path></svg></span></h3><ul class="hide"><li class="navListItem"><a class="navItem" href="/amphora/docs/advanced">Advanced</a></li><li class="navListItem"><a class="navItem" href="/amphora/docs/storage">Storage API</a></li><li class="navListItem"><a class="navItem" href="/amphora/docs/data_versioning">Data Versioning (Upgrades)</a></li><li class="navListItem"><a class="navItem" href="/amphora/docs/renderer-models">Renderer Models</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle collapsible">Helpful Links<span class="arrow"><svg width="24" height="24" viewBox="0 0 24 24"><path fill="#565656" d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path><path d="M0 0h24v24H0z" fill="none"></path></svg></span></h3><ul class="hide"><li class="navListItem"><a class="navItem" href="/amphora/docs/glossary-docs">Glossary</a></li></ul></div></div></section></div><script>
            var coll = document.getElementsByClassName('collapsible');
            var checkActiveCategory = true;
            for (var i = 0; i < coll.length; i++) {
              var links = coll[i].nextElementSibling.getElementsByTagName('*');
              if (checkActiveCategory){
                for (var j = 0; j < links.length; j++) {
                  if (links[j].classList.contains('navListItemActive')){
                    coll[i].nextElementSibling.classList.toggle('hide');
                    coll[i].childNodes[1].classList.toggle('rotate');
                    checkActiveCategory = false;
                    break;
                  }
                }
              }

              coll[i].addEventListener('click', function() {
                var arrow = this.childNodes[1];
                arrow.classList.toggle('rotate');
                var content = this.nextElementSibling;
                content.classList.toggle('hide');
              });
            }

            document.addEventListener('DOMContentLoaded', function() {
              createToggler('#navToggler', '#docsNav', 'docsSliderActive');
              createToggler('#tocToggler', 'body', 'tocActive');

              const headings = document.querySelector('.toc-headings');
              headings && headings.addEventListener('click', function(event) {
                if (event.target.tagName === 'A') {
                  document.body.classList.remove('tocActive');
                }
              }, false);

              function createToggler(togglerSelector, targetSelector, className) {
                var toggler = document.querySelector(togglerSelector);
                var target = document.querySelector(targetSelector);

                if (!toggler) {
                  return;
                }

                toggler.onclick = function(event) {
                  event.preventDefault();

                  target.classList.toggle(className);
                };
              }
            });
        </script></nav></div><div class="container mainContainer"><div class="wrapper"><div class="post"><header class="postHeader"><h1 class="postHeaderTitle">Event Bus</h1></header><article><div><span><p>As of Amphora version <code>6.6.0</code>, the option of using <a href="https://redis.io/topics/pubsub">Redis as an event bus</a> has been introduced. This event bus is intended to make it easier to a destructure a Clay instance and supporting platform packages (i.e. Amphora Search). By default, the Bus module is not instantiated. Only by setting the <a href="event-bus#redis-bus-host">Redis Bus Host env var</a> will the Bus module be active.</p>
<p>The Event Bus is also intended to replace the plugin system in the next major version of Amphora (v7). On top of replacing the plugin system, the event bus will see some small changes to the payload of certain events as the plugin system is rearchitected. The end goal is to expose specific hooks in the Amphora lifecycle to the Bus as quickly as possible.</p>
<h2><a class="anchor" aria-hidden="true" id="bus-topics"></a><a href="#bus-topics" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Bus Topics</h2>
<p>The following topics are published to the bus by Amphora:</p>
<ul>
<li><code>clay:publishLayout</code></li>
<li><code>clay:publishPage</code></li>
<li><code>clay:createPage</code></li>
<li><code>clay:unschedulePage</code></li>
<li><code>clay:schedulePage</code></li>
<li><code>clay:unpublishPage</code></li>
<li><code>clay:save</code></li>
<li><code>clay:delete</code></li>
</ul>
<h2><a class="anchor" aria-hidden="true" id="configuring-the-bus"></a><a href="#configuring-the-bus" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Configuring the Bus</h2>
<p>The Bus module has two configurations options which are both controlled by environment variables.</p>
<h3><a class="anchor" aria-hidden="true" id="redis-bus-host"></a><a href="#redis-bus-host" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Redis Bus Host</h3>
<p>As mentioned, the Bus module is turned off by default. Only by setting the <code>CLAY_BUS_HOST</code> env var to a valid Redis url (<code>redis://&lt;HOST&gt;:&lt;PORT&gt;</code>) will the module be instantiated and events will be published to the instance.</p>
<h3><a class="anchor" aria-hidden="true" id="namespace"></a><a href="#namespace" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Namespace</h3>
<p>By default, all topics published to the Bus are namespaced using <code>clay</code>, i.e. <code>clay:&lt;ACTION&gt;</code>. This namespace can be configured by the env var <code>CLAY_BUS_NAMESPACE</code>. For example, setting <code>CLAY_BUS_NAMESPACE</code> to a value of <code>mysite</code> will publish all events as <code>mysite:&lt;ACTION&gt;</code>.</p>
<h2><a class="anchor" aria-hidden="true" id="subscribing-to-the-bus"></a><a href="#subscribing-to-the-bus" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Subscribing To The Bus</h2>
<p>Provided you have setup Amphora to pub to a Redis instance, the following code will subscribe to all events from Clay using the <a href="https://www.npmjs.com/package/redis"><code>redis</code></a> NPM module.</p>
<pre><code class="hljs css language-javascript"><span class="hljs-meta">'use strict'</span>;

<span class="hljs-keyword">var</span> redis = <span class="hljs-built_in">require</span>(<span class="hljs-string">'redis'</span>),
  SUBSCRIBER = redis.createClient(process.env.CLAY_BUS_HOST),
  CLAY_TOPICS = [
    <span class="hljs-string">'publishLayout'</span>,
    <span class="hljs-string">'publishPage'</span>,
    <span class="hljs-string">'unpublishPage'</span>,
    <span class="hljs-string">'createPage'</span>,
    <span class="hljs-string">'schedulePage'</span>,
    <span class="hljs-string">'unschedulePage'</span>,
    <span class="hljs-string">'save'</span>,
    <span class="hljs-string">'delete'</span>
  ];

<span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; CLAY_TOPICS.length; i++) {
  SUBSCRIBER.subscribe(<span class="hljs-string">`clay:<span class="hljs-subst">${CLAY_TOPICS[i]}</span>`</span>);
}

SUBSCRIBER.on(<span class="hljs-string">'message'</span>, (channel, payload) =&gt; {
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">`Channel: <span class="hljs-subst">${channel}</span>\n\n\n<span class="hljs-subst">${payload}</span>`</span>);
});
</code></pre>
</span></div></article></div><div class="docs-prevnext"><a class="docs-prev button" href="/amphora/docs/building-renderers"><span class="arrow-prev">← </span><span>Building Custom Renderers</span></a><a class="docs-next button" href="/amphora/docs/advanced"><span>Advanced</span><span class="arrow-next"> →</span></a></div></div></div><nav class="onPageNav"><ul class="toc-headings"><li><a href="#bus-topics">Bus Topics</a></li><li><a href="#configuring-the-bus">Configuring the Bus</a><ul class="toc-headings"><li><a href="#redis-bus-host">Redis Bus Host</a></li><li><a href="#namespace">Namespace</a></li></ul></li><li><a href="#subscribing-to-the-bus">Subscribing To The Bus</a></li></ul></nav></div><footer class="nav-footer" id="footer"><section class="sitemap"><a href="/amphora/" class="nav-home"></a><div><h5>Docs</h5><a href="/amphora/docs/en/intro">Introduction</a><a href="/amphora/docs/en/glossary-docs">Glossary</a></div><div><h5>More</h5><a target="_blank" href="https://github.com/clay/amphora">GitHub</a></div></section><section class="copyright">Copyright © 2019 New York Media</section></footer></div></body></html>